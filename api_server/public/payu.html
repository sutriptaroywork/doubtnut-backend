<!DOCTYPE html>
<html>

<head>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Mukta:wght@300;400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.1/css/bootstrap.min.css" integrity="sha512-Ez0cGzNzHR1tYAv56860NLspgUGuQw16GiOOp/I2LuTmpSK9xDXlgJz3XN4cnpXWDmkNBKXR/VDMTCnAaEooxA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        html,body{margin:0 auto; font-family: 'Mukta', sans-serif;; position: relative; background: #f85032; width:100%; height:100%;}
        body{ background:  #ffffff;}
        .lato {font-family: 'Lato', sans-serif;}
        #wrapper { width: 96%; margin: 0 auto; padding-top: 10px;
            height: calc(100% - 60px);
            overflow: scroll;}
        .purple {color:#4a54bd}
        .gray {color: #acacac}
        button.btn-primary, .btn-primary:hover {
            border-radius: 0;
            border-color: #eb532c;
            background: #eb532c;
            color: white;
        }

        .btn-primary.disabled,
        .btn-primary:disabled {
            color: #fff;
            background-color: #cbcbcb;
            border-color: #cbcbcb;
        }

        .btn-outline-primary,
        .btn-outline-primary:hover {
            border-radius: 0;
            border-color: #eb532c;
            background: #fff;
            color: #eb532c;
        }

        .btn-outline-primary.disabled,
        .btn-outline-primary:disabled {
            color: #fff;
            background-color: #cbcbcb;
            border-color: #cbcbcb;
        }
    </style>
    <style>
        .margin-bottom-0 {
            margin-bottom: 0;
        }

        #pre-loader {
            background: white;
            position: fixed;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            z-index: 4;
        }
    </style>
    <style>
        .spinner {
            width: 40px;
            height: 40px;
            top: 45%;
            position: relative;
            margin: auto auto;
        }

        .double-bounce1,
        .double-bounce2 {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #eb532c;
            opacity: 0.6;
            position: absolute;
            top: 0;
            left: 0;
            -webkit-animation: sk-bounce 2.0s infinite ease-in-out;
            animation: sk-bounce 2.0s infinite ease-in-out;
        }

        .double-bounce2 {
            -webkit-animation-delay: -1.0s;
            animation-delay: -1.0s;
        }

        @-webkit-keyframes sk-bounce {

            0%,
            100% {
                -webkit-transform: scale(0.0)
            }

            50% {
                -webkit-transform: scale(1.0)
            }
        }

        @keyframes sk-bounce {

            0%,
            100% {
                transform: scale(0.0);
                -webkit-transform: scale(0.0);
            }

            50% {
                transform: scale(1.0);
                -webkit-transform: scale(1.0);
            }
        }
    </style>
</head>

<body>
    <section id="pre-loader">
        <div class="spinner">
            <div class="double-bounce1"></div>
            <div class="double-bounce2"></div>
        </div>
    </section>
    <section id="wrapper">
        <style>
            .header {
                border-bottom: 1px solid #e2e2e2;
                height: 50px;
            }

            footer {
                position: fixed;
                z-index: 1;
                left: 0;
                bottom: 0;
                width: 100%;
                height: auto;
            }
        </style>

        <section id="get-card-bin" class="main-s d-none">
            <header class="header">
                <div class="d-flex justify-content-between bd-highlight mb-3">
                    <div class="p-2 bd-highlight back-press">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 16 16">
                            <path fill="#504949" fill-rule="evenodd"
                                d="M14 7.25H4.872l4.193-4.192L8 2 2 8l6 6 1.057-1.057L4.872 8.75H14v-1.5z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div id="bin-page-title" class="p-2 bd-highlight fw-bold title">Apni Card Detail Bharein</div>
                    <div class="p-2 bd-highlight close-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 16 16">
                            <path fill="#504949"
                                d="M13 4.007L11.993 3 8 6.993 4.007 3 3 4.007 6.993 8 3 11.993 4.007 13 8 9.007 11.993 13 13 11.993 9.007 8 13 4.007z" />
                        </svg>
                    </div>
                </div>
            </header>
            <br>
            <article class="w-90">
                <h3 style="text-align: center;">Apne card ki pehli 6 digits daalein</h3>
                <form class="row g-3">
                    <div class="col-12">
                        <input id="card-bin" type="text" name="input-card-bin" maxlength="6" pattern="[0-9]{6}" class="form-control"
                            placeholder="Card No ki first 6 digits" autocomplete="off">
                        <div class="form-error" style="color: red;"></div>
                    </div>
                </form>
            </article>
            <br>
            <br>
            <br>
            <div>
                <p style="text-align: center;">Please check your eligibility for EMI</p>
            </div>
            <div id="sww-form" style="color: red; display: none;">
                <p>Something went wrong</p>
            </div>
            <footer>
                <div class="d-grid gap-2">
                    <button class="btn btn btn-primary btn-lg" type="button" id="card-bin-submit">Check Eligibility</button>
                </div>
            </footer>
        </section>

        <section id="eligibility-page" class="main-s d-none">
            <style>
                .green-order-tick {
                    background: #54b726;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    margin: auto;
                }

                .light-gray-color {
                    color: #504949
                }
            </style>
            <header class="header">
                <div class="d-flex justify-content-between bd-highlight mb-3">
                    <div class="p-2 bd-highlight back-press"
                        data-val='{ "type": "deeplink", "data": { "value": "###deeplink###" } }'>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 16 16">
                            <path fill="#504949" fill-rule="evenodd"
                                d="M14 7.25H4.872l4.193-4.192L8 2 2 8l6 6 1.057-1.057L4.872 8.75H14v-1.5z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div id='eligibility-title' class="p-2 bd-highlight fw-bold">Eligibility Response</div>
                    <div class="p-2 bd-highlight close-button"
                        data-val='{ "type": "deeplink", "data": { "value": "###deeplink###" } }'>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 16 16">
                            <path fill="#504949"
                                d="M13 4.007L11.993 3 8 6.993 4.007 3 3 4.007 6.993 8 3 11.993 4.007 13 8 9.007 11.993 13 13 11.993 9.007 8 13 4.007z" />
                        </svg>
                    </div>
                </div>
            </header>
            <br>
            <article class="w-90">
                <br>
                <br>
                <div class="text-center">
                    <div class="green-order-tick text-center" style="display: inherit;">
                        <div style="padding-top: 10px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="29" height="29" fill="none"
                                viewBox="0 0 29 29">
                                <path fill="#fff"
                                    d="M10.649 22.592l14.37-14.475-1.696-1.708-12.674 12.796-5.001-5.037-1.667 1.708 6.668 6.716z" />
                            </svg>
                        </div>
                    </div>
                    <br>
                    <h4 id="eligible-heading" class="fw-bold" style="display: inherit;">Congratulations! Aap EMI ke liye
                        eligible hain</h4>
                    <h4 id="ineligible-heading" class="fw-bold" style="display: inherit;">Sorry! Aap EMI ke liye
                        eligible nahi hain</h4>
                    <br>
                    <form id="details-form" class="row g-3" style="display: inherit;">
                        <div class="col-12">
                            <input id="full-name" type="text" name="input-full-name" class="form-control" placeholder="Full Name" autocomplete="off">
                            <div id="full-name-error" class="form-error" style="color: red;"></div>
                        </div>
                        <div class="col-12">
                            <input id="mobile-number" type="text" name="input-mobile" pattern="[0-9]{10}" maxlength="10"
                                class="form-control" placeholder="Bank se linked Mobile Number" autocomplete="off" value="">
                            <div id="mobile-number-error" class="form-error" style="color: red;"></div>
                        </div>
                        <div class="col-12">
                            <input id="email" type="text" name="input-email" class="form-control" placeholder="Email ID" autocomplete="off">
                            <div id="email-error" class="form-error" style="color: red;"></div>
                        </div>
                    </form>
                    <br>
                    <br>
                    <div id="sww-form" style="color: red; display: none;">
                        <p>Something went wrong</p>
                    </div>
                </div>
                <form id="post-form" action="https://test.payu.in/_payment" method="post">
                    <input id="key" type="hidden" name="key" value="7MFZy1">
                    <input id="txnid" type="hidden" name="txnid" value="1">
                    <input id="amount" type="hidden" name="amount" value="20000">
                    <input id="productinfo" type="hidden" name="productinfo" value="Doubtnut Course">
                    <input id="firstname" type="hidden" name="firstname" value="Prakher">
                    <input id="email" type="hidden" name="email" value="prakher.gaushal@doubtnut.com">
                    <input id="phone" type="hidden" name="phone" value="9149302901">
                    <input id="surl" type="hidden" name="surl" value="https://www.doubtnut.com">
                    <input id="furl" type="hidden" name="furl" value="https://www.doubtnut.com">
                    <input id="enforce_paymethod" type="hidden" name="enforce_paymethod" value="emi">
                    <input id="hash" type="hidden" name="hash" value="b01c3b43192e142924daf0520ae2727eb4c6a065b1ec707c86fedbf802a60d53959abea00c408def30e197702504be22987d8e423b90d552323e52ed98537a74">
                    <input id="create-txn-submit" style="display: none;" type="submit" value="Proceed to PayU">
                </form>
            </article>
            <footer>
                <div class="d-grid gap-2">
                    <button id="add-details-submit" style="display: inherit;" class="btn btn btn-primary btn-lg" type="button">Proceed to PayU</button>
                </div>
            </footer>
        </section>
    </section>
    <style></style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.1/js/bootstrap.min.js"
        integrity="sha512-EKWWs1ZcA2ZY9lbLISPz8aGR2+L7JVYqBAYTq5AXgBkSjRSuQEGqWx8R1zAX16KdXPaCjOCaKE8MCpU0wcHlHA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
        integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        let back_stack = [];
        let domain = window.location.protocol + "//" + window.location.hostname;
        // let domain = 'https://api.doubtnut.com';

        const urlParams = new URLSearchParams(window.location.search);
        let token = urlParams.get('token');
        let info = urlParams.get('info');

        const payuDetails = JSON.parse(info);
        const amount = payuDetails.amount;
        const studentId = payuDetails.student_id;
        const variantId = payuDetails.variant_id;
        const courseName = payuDetails.course_name;
        const locale = payuDetails.locale;
        const version_code = payuDetails.version_code;
        let cardBin;
        let mobile;
        let consumerName;
        let email;

        $(document).ready(async function () {
            $(".main-s").addClass("d-none");
            $("#get-card-bin.main-s").removeClass("d-none");
            $("#pre-loader").hide();
        });

        $("#card-bin-submit").click(async function () {
            cardBin = $('[name="input-card-bin"]').val();
            let error_in_form = false;
            if (!(cardBin.match(/^\d{6}$/))) {
                $('[name="input-card-bin"] + .form-error').html("Card Number ke pehle 6 digits galat he.");
                error_in_form = true;
            }

            if (!error_in_form) {
                $("#card-bin-submit").attr("disabled", true);
                $("#get-card-bin.main-s").addClass("d-none");
                $("#pre-loader").show();
                const payload = {
                    amount,
                    cardBin: `${cardBin}`,
                };
                const response = await checkEmiEligibility(payload);
                console.log(response);
                if (response.meta.success) {
                    emiEligibility = response.data.details.isEligible;
                    $("#pre-loader").hide();
                    back_stack_push($(this).closest(".main-s").attr("id"));
                    $("#eligibility-page.main-s").removeClass("d-none");
                    if (emiEligibility == 1) {
                        $('#ineligible-heading').css("display", "none");
                        $('#full-name-error').css("display", "none");
                        $('#mobile-number-error').css("display", "none");
                        $('#email-error').css("display", "none");
                        $("#add-details-submit").click(async function () {
                            consumerName = $('[name="input-full-name"]').val();
                            mobile = $('[name="input-mobile"]').val();
                            email = $('[name="input-email"]').val();
                            let error_in_form = false;
                            if (consumerName.length == 0) {
                                $('#full-name-error').css("display", "inherit");
                                $('[name="input-full-name"] + .form-error').html("Name zaroori he");
                                error_in_form = true;
                            }
                            if (!(mobile.match(/^\d{10}$/))) {
                                $('#mobile-number-error').css("display", "inherit");
                                $('[name="input-mobile"] + .form-error').html("Phone number galat he. Dobara check karen.");
                                error_in_form = true;
                            }
                            if (!(email.toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/))) {
                                $('#email-error').css("display", "inherit");
                                $('[name="input-email"] + .form-error').html("Email galat he. Dobara check karen.");
                                error_in_form = true;
                            }

                            if (!error_in_form) {
                                $("#add-details-submit").attr("disabled", true);
                                $("#eligibility-page.main-s").addClass("d-none");
                                $("#pre-loader").show();

                                const payload = {
                                    email, courseName, consumerName, studentId, variantId,
                                };
                                const response = await createPayuTransaction(payload);
                                console.log(response);
                                if (response.meta.success) {
                                    $("#pre-loader").hide();
                                    back_stack_push($(this).closest(".main-s").attr("id"));
                                    $('#post-form').attr('action', `${response.data.base_url}/_payment`);
                                    $('[name="key"]').val(response.data.key);
                                    $('[name="txnid"]').val(`${response.data.txnid}`);
                                    $('[name="amount"]').val(`${response.data.amount}`);
                                    $('[name="productinfo"]').val(courseName);
                                    $('[name="firstname"]').val(consumerName);
                                    $('[name="email"]').val(email);
                                    $('[name="phone"]').val(`${mobile}`);
                                    $('[name="furl"]').val(response.data.furl);
                                    $('[name="surl"]').val(response.data.surl);
                                    $('[name="hash"]').val(response.data.hash);
                                    $("#create-txn-submit").trigger('click');
                                } else {
                                    $("#eligibility-page.main-s").removeClass("d-none");
                                    $("#pre-loader").hide();
                                    $('#sww-form').css("display", "inherit");
                                    setTimeout(function () {
                                        Android.handleAction('{ "type": "close", "data": { } }');
                                    }, 3000);
                                }
                            }
                        });
                    } else {
                        $('.green-order-tick').css("display", "none");
                        $('#eligible-heading').css("display", "none");
                        $('#details-form').css("display", "none");
                        $('#add-details-submit').css("display", "none");
                        setTimeout(function () {
                            Android.handleAction('{ "type": "close", "data": { } }');
                        }, 3000);
                    }
                } else {
                    $("#get-card-bin.main-s").removeClass("d-none");
                    $("#pre-loader").hide();
                    $('#sww-form').css("display", "inherit");
                    setTimeout(function () {
                        Android.handleAction('{ "type": "close", "data": { } }');
                    }, 3000);
                }
            }
        });

        async function checkEmiEligibility(obj) {
            var settings = {
                "url": domain + "/v1/payment/payu/check-emi-eligibility",
                "method": "POST",
                "timeout": 0,
                "headers": {
                    "x-auth-token": token,
                    "version_code": version_code,
                    "Content-Type": "application/json"
                },
                "data": JSON.stringify(obj),
            };

            return new Promise((async (resolve, reject) => {
                $.ajax(settings).done(function (response) {
                    console.log(response);
                    resolve(response);
                });
            }));
        }

        async function createPayuTransaction(obj) {
            var settings = {
                "url": domain + "/v1/payment/payu/create-transaction",
                "method": "POST",
                "timeout": 0,
                "headers": {
                    "x-auth-token": token,
                    "version_code": version_code,
                    "Content-Type": "application/json"
                },
                "data": JSON.stringify(obj),
            };

            return new Promise((async (resolve, reject) => {
                $.ajax(settings).done(function (response) {
                    console.log(response);
                    resolve(response);
                });
            }));
        }

        $(".close-button").click(function () {
            Android.handleAction('{ "type": "close", "data": { } }');
        });

        $(".back-press").click(function () {
            if (back_stack.length == 0) {
                $(".close-button").click();
            } else {
                let id = back_stack.pop();
                $(".main-s").addClass("d-none");
                $("#" + id).removeClass("d-none");
                $("#" + id + " button.btn").attr("disabled", false);
                back_stack.push();
            }
        });

        function back_stack_push(screen) {
            back_stack.push(screen);
        }
    </script>

</html>